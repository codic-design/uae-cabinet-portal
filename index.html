<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UAE CABINET MEETINGS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face {
            font-family: 'DINNextBold';
            src: url('https://cdn.jsdelivr.net/gh/codic-design/source/FONTS/DIN_NEXT_ARABIC_BOLD.otf') format('opentype');
        }
        @font-face {
            font-family: 'DINNextRegular';
            src: url('https://cdn.jsdelivr.net/gh/codic-design/source/FONTS/DIN_NEXT_ARABIC_REGULAR.otf') format('opentype');
        }

        body {
            background-color: white;
            font-family: 'DINNextRegular', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .font-bold { font-family: 'DINNextBold', sans-serif; }
        .bg-uae-blue { background-color: #07355c; }

        .pill-container {
            border-radius: 96px;
            max-width: 1100px;
            width: 100%;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .number-circle-header {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0b4573 0%, #05233d 100%);
            border: 2px solid #ffffff33;
            display: flex; align-items: center; justify-content: center;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            transition: all 0.5s ease;
        }

        .number-circle-item {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            display: flex; align-items: center; justify-content: center;
            color: #07355c;
            box-shadow: inset 4px 4px 10px rgba(0,0,0,0.05), -3px 0px 8px rgba(0,0,0,0.04);
            transition: all 0.5s ease;
        }

        .header-title { font-size: 26px; transition: all 0.5s ease; }
        .header-date { font-size: 18px; transition: all 0.5s ease; }
        .topic-title { color: #000000; font-size: 20px; line-height: 1.3; transition: all 0.5s ease; }
        .entity-name { color: #6b7280; font-size: 16px; line-height: 1.3; }
        
        .compact-mode .header-title { font-size: 22px; }
        .compact-mode .topic-title { font-size: 17px; }
        .compact-mode .pill-container { padding-right: 96px !important; }
        .compact-mode .number-circle-item { width: 68px; height: 68px; }

        .item-shadow {
            border: 1px solid #e5e7eb;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06), 0 2px 6px rgba(0, 0, 0, 0.04);
        }

        .topic-item { transition: transform 0.2s ease, border-color 0.5s ease; }
        .topic-item:hover { transform: scale(1.005); }
        .accordion-item.active .topic-item { border-color: #07355c; border-width: 1.5px; }

        .accordion-item {
            max-width: 1100px;
            width: 100%;
            min-height: 96px;
            display: flex; flex-direction: column; justify-content: flex-start;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .modal-overlay { 
            display: none; 
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active { 
            display: flex; 
            opacity: 1;
        }

        .ai-input-wrapper {
            border: 1.5px solid #07355c;
            border-radius: 28px;
            background: white;
            padding: 16px;
            transition: all 0.3s ease;
        }
        .ai-shortcut-btn {
            background: #07355c;
            color: white;
            font-size: 11px;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .ai-shortcut-btn:hover { background-color: #0b4573; transform: translateY(-1px); }

        .ai-card {
            animation: slideUp 0.4s ease-out forwards;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-ai {
            box-shadow: 0 0 0 0 rgba(7, 53, 92, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(7, 53, 92, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(7, 53, 92, 0); }
            100% { box-shadow: 0 0 0 0 rgba(7, 53, 92, 0); }
        }

        .scrollable-topic-container {
            max-height: 450px;
            overflow-y: auto;
            padding-bottom: 2rem;
            margin-top: 1rem;
        }

        .count-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background-color: #07355c;
            color: white;
            font-size: 9px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 1.5px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="overflow-hidden bg-white text-[#07355c]">

    <!-- ================= LANDING PAGE ================= -->
    <div id="landing-page" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-[#07355c] bg-no-repeat transition-opacity duration-700 ease-in-out" style="background-image: url('https://cdn.jsdelivr.net/gh/codic-design/source/IMAGES/QASR_AL_WATAN.png'); background-position: center; background-size: cover;">
        <div class="flex flex-col items-center z-10 text-center -mt-48 md:-mt-64">
            <img src="https://cdn.jsdelivr.net/gh/codic-design/source/LOGOS/UAE_CABINET_LOGO_W_V.svg" alt="UAE Cabinet Logo" class="h-32 md:h-40 w-auto mb-8">
            <h1 class="font-bold text-white text-2xl md:text-4xl mb-4 tracking-wide">جدول أعمال اجتماع مجلس الوزراء</h1>
            <p class="text-white text-base md:text-lg opacity-90 mb-10">20 فبراير 2026</p>
            <button onclick="startApp()" class="bg-white/65 backdrop-blur-sm text-[#07355c] font-bold text-sm md:text-base px-12 py-2.5 rounded-full hover:scale-105 hover:bg-white/80 transition-all shadow-lg">إبدأ</button>
        </div>
    </div>

    <!-- ================= MAIN APP PAGE ================= -->
    <div id="app-page" class="hidden opacity-0 transition-opacity duration-700 ease-in-out h-screen w-full relative z-10 overflow-y-auto overflow-x-hidden">
        
        <div class="flex flex-row items-start justify-end w-full min-h-full px-0 py-12">
            
            <!-- RIGHT EDGE SPACER (30px) -->
            <div class="w-[30px] shrink-0 order-2"></div>

            <!-- MAIN CONTENT BLOCK -->
            <main id="main-content" class="flex-1 flex flex-col items-center transition-all duration-500 order-1">
                <div class="max-w-[1100px] w-full flex flex-col mx-auto">
                    
                    <header class="pill-container bg-uae-blue text-white relative flex items-center min-h-[96px] shadow-xl mb-12 pl-8 pr-[104px] py-3">
                        <div class="absolute right-[8px] top-1/2 -translate-y-1/2 number-circle-header"><span class="font-bold text-4xl">1</span></div>
                        <div class="flex flex-col justify-center text-right w-full">
                            <span class="font-bold header-title m-0">جدول أعمال اجتماع مجلس الوزراء</span>
                            <span class="header-date opacity-90 mt-1">20 فبراير 2026</span>
                        </div>
                        <div class="absolute left-[32px] top-1/2 -translate-y-1/2">
                            <img src="https://cdn.jsdelivr.net/gh/codic-design/source/LOGOS/UAE_CABINET_LOGO_W.svg" alt="UAE Logo" class="h-14 lg:h-16 w-auto object-contain">
                        </div>
                    </header>

                    <div class="space-y-6 pb-20 w-full" id="topics-list">
                        
                        <!-- Topic 1 -->
                        <div class="accordion-item relative group" data-topic-id="1">
                            <div class="pill-container topic-item item-shadow bg-white relative flex items-center min-h-[96px] pl-8 pr-[104px] py-3 cursor-pointer z-10" onclick="toggleAccordion(this)">
                                <div class="absolute right-[8px] top-1/2 -translate-y-1/2 number-circle-item"><span class="font-bold text-[30px]">1</span></div>
                                <div class="flex flex-col justify-center text-right w-full">
                                    <span class="font-bold topic-title text-right">إنجازات حكومة دولة الإمارات خلال الـ (20) عام (2006-2025).</span>
                                    <span class="entity-name mt-1">مجلس الوزراء</span>
                                </div>
                                <div class="absolute left-[40px] top-1/2 -translate-y-1/2 flex items-center gap-3">
                                    <div id="note-indicator-1" class="hidden relative hover:scale-110 transition-transform p-2 bg-gray-50 rounded-full" onclick="event.stopPropagation(); openNoteModal('1')">
                                        <svg viewBox="0 0 24 24" width="22" height="22" stroke="#07355c" stroke-width="2" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line></svg>
                                        <span id="note-count-1" class="count-badge">0</span>
                                    </div>
                                    <div id="ai-indicator-1" class="hidden relative pulse-ai hover:scale-110 transition-transform p-1 bg-blue-50 rounded-full border border-blue-200 shadow-sm" onclick="event.stopPropagation(); openSidebarWithFocus('1')">
                                        <img src="https://cdn.jsdelivr.net/gh/codic-design/source/IMAGES/AI.gif" class="w-7 h-7 rounded-full object-cover">
                                        <span id="ai-count-1" class="count-badge">0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-body bg-[#e5e9ef] overflow-hidden max-h-0 transition-[max-height] duration-500 ease-in-out relative z-0 -mt-[48px] rounded-b-[48px]">
                                <div class="px-10 pb-12 pt-[80px] relative text-[#4b5563] text-[13.5px] leading-relaxed">
                                    
                                    <!-- Repositioned X button at the right -->
                                    <button onclick="closeAccordion(event, this)" class="absolute top-[80px] right-8 text-[#07355c] hover:opacity-70 p-2">
                                        <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                    </button>

                                    <!-- Toolbar now only contains Add Note, aligned left -->
                                    <div class="flex items-center justify-end mb-4 w-full">
                                        <button onclick="openNoteModal('1')" class="flex items-center gap-2 border border-[#07355c] bg-white rounded-full px-5 py-1.5 text-[#07355c] text-sm font-bold hover:bg-gray-50 transition-colors">
                                            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                            أضف ملاحظة
                                        </button>
                                    </div>

                                    <div id="topic-content-1" class="scrollable-topic-container custom-scrollbar grid grid-cols-1 md:grid-cols-2 gap-10 pr-[20px] text-justify leading-relaxed">
                                        <div class="space-y-4">
                                            <p>في الخامس من يناير عام 2006 بدأت دولة الإمارات فصلاً جديداً من الرؤية الاستراتيجية، والطموحات التي لا تعرف حدوداً، مع تولي صاحب السموّ الشيخ محمد بن راشد آل مكتوم، نائب رئيس الدولة رئيس مجلس الوزراء حاكم دبي، رعاه الله، رئاسة حكومة دولة الإمارات، حيث مثّلت هذه المحطة الوطنية نقطة انطلاق نحو مرحلة تاريخية جديدة من التنمية الشاملة بجوانبها كافة.</p>
                                            <p>شكلت رؤية سموّه الاستباقية في صياغة المستقبل ومدرسته في القيادة، أساساً لتحولات نوعية، قاد من خلالها حكومة دولة الإمارات لوضع ركائز قوية، مكّنت الدولة من تجاوز المستحيل، وتحويل الطموح إلى واقع ملموس ومستدام عبر سياسات واستراتيجيات ومبادرات كان لها الأثر الفاعل.</p>
                                        </div>
                                        <div class="space-y-4">
                                            <p>وجسّدت هذه السياسات والاستراتيجيات الحكومية في مجملها نهجاً راسخاً، يضع الإنسان والارتقاء بجودة حياته ورفاهه أولوية مطلقة في جميع الأجندات والبرامج والمشروعات الحكومية، حيث استهدفت حكومة الإمارات بناء منظومات متكاملة تضمن الرفاه الأسري.</p>
                                            <p>وشكّل ترسيخ تنافسية اقتصاد الإمارات على المستوى العالمي أولوية قصوى في أجندة حكومة الإمارات، وتمحورت الجهود في هذا المجال حول التنوع، وتقليل الاعتماد على النفط، والاستثمار في قطاعات القيمة المضافة العالية، وارتكزت هذه الجهود على حزمة من الاستراتيجيات والسياسات الوطنية الجريئة من عام 2006 وحتى عام 2025.</p>
                                        </div>
                                    </div>
                                    <div class="absolute right-[24px] top-[90px] bottom-[48px] w-[3px] bg-[#d1d5db] rounded-full">
                                        <div class="absolute -right-[5.5px] top-0 w-[14px] h-[14px] border-[3px] border-[#d1d5db] bg-white rounded-full"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Topics 2-6 -->
                        <script>
                            const titles = [
                                "اعتماد الدليل الإرشادي للخدمات الرقمية المستدامة في الحكومة الاتحادية.",
                                "اعتماد سياسة حوكمة إجراء توريد فوائض تنفيذ الميزانية العامة للاتحاد.",
                                "تحديث نظام تمويل مؤسسات التعليم العالي الحكومية.",
                                "تحديث نظام الوزارة لاعتماد الجامعات خارج الدولة.",
                                "اعتماد نظام المناهج الدراسية الوطنية الموحد."
                            ];
                            const entities = ["وزارة المالية", "وزارة المالية", "وزارة المالية", "وزارة التعليم العالي", "وزارة التربية والتعليم"];
                            const descriptions = [
                                "يعمل هذا الدليل على ضمان تقديم خدمات رقمية مستدامة وكفوءة في كافة الجهات الحكومية الاتحادية، مما يعزز تجربة المتعامل ويقلل الأثر البيئي للتحول الرقمي المتسارع.",
                                "تهدف السياسة إلى تنظيم إدارة الفوائض المالية الناتجة عن تنفيذ الميزانية العامة للاتحاد لضمان الاستقرار المالي طويل الأمد ودعم المشاريع الوطنية الكبرى.",
                                "تطوير معايير التمويل لربط الميزانيات بجودة المخرجات الأكاديمية والبحثية والابتكار المستمر لتعزيز مكانة التعليم العالي الإماراتي.",
                                "تحديث السياسات والاشتراطات الخاصة بالاعتراف بمؤسسات التعليم العالي الأجنبية لضمان حصول الطلاب على أفضل جودة تعليمية عالمية.",
                                "توحيد الأطر العامة للمناهج التعليمية بما يواكب التطورات العلمية المتسارعة ويعزز الهوية الوطنية في قلوب الناشئة."
                            ];
                            
                            titles.forEach((title, i) => {
                                const id = i + 2;
                                document.write(`
                                    <div class="accordion-item relative group" data-topic-id="${id}">
                                        <div class="pill-container topic-item item-shadow bg-white relative flex items-center min-h-[96px] pl-8 pr-[104px] py-3 cursor-pointer z-10" onclick="toggleAccordion(this)">
                                            <div class="absolute right-[8px] top-1/2 -translate-y-1/2 number-circle-item"><span class="font-bold text-[30px]">${id}</span></div>
                                            <div class="flex flex-col justify-center text-right w-full">
                                                <span class="font-bold topic-title">${title}</span>
                                                <span class="entity-name mt-1">${entities[i]}</span>
                                            </div>
                                            <div class="absolute left-[40px] top-1/2 -translate-y-1/2 flex items-center gap-3">
                                                <div id="note-indicator-${id}" class="hidden relative hover:scale-110 transition-transform p-2 bg-gray-50 rounded-full" onclick="event.stopPropagation(); openNoteModal('${id}')">
                                                    <svg viewBox="0 0 24 24" width="22" height="22" stroke="#07355c" stroke-width="2" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                                    <span id="note-count-${id}" class="count-badge">0</span>
                                                </div>
                                                <div id="ai-indicator-${id}" class="hidden relative pulse-ai hover:scale-110 transition-transform p-1 bg-blue-50 rounded-full border border-blue-200 shadow-sm" onclick="event.stopPropagation(); openSidebarWithFocus('${id}')">
                                                    <img src="https://cdn.jsdelivr.net/gh/codic-design/source/IMAGES/AI.gif" class="w-7 h-7 rounded-full object-cover">
                                                    <span id="ai-count-${id}" class="count-badge">0</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="accordion-body bg-[#e5e9ef] overflow-hidden max-h-0 transition-[max-height] duration-500 ease-in-out relative z-0 -mt-[48px] rounded-b-[48px]">
                                            <div class="px-10 pb-12 pt-[80px] relative text-[#4b5563] text-[13.5px] leading-relaxed">
                                                <!-- Separate X button at right -->
                                                <button onclick="closeAccordion(event, this)" class="absolute top-[80px] right-8 text-[#07355c] hover:opacity-70 p-2">
                                                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                                </button>

                                                <div class="flex items-center justify-end mb-4 w-full">
                                                    <button onclick="openNoteModal('${id}')" class="flex items-center gap-2 border border-[#07355c] bg-white rounded-full px-5 py-1.5 text-[#07355c] text-sm font-bold hover:bg-gray-50 transition-colors">
                                                        <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                                        أضف ملاحظة
                                                    </button>
                                                </div>
                                                <div id="topic-content-${id}" class="scrollable-topic-container custom-scrollbar grid grid-cols-1 md:grid-cols-2 gap-10 pr-[20px] text-justify leading-relaxed">
                                                    <div class="space-y-4">
                                                        <p>${descriptions[i]}</p>
                                                    </div>
                                                    <div class="space-y-4">
                                                        <p>يتضمن هذا القرار مجموعة من المبادرات النوعية التي تم صياغتها لتواكب تطلعات حكومة دولة الإمارات العربية المتحدة لعام 2030 وضمان الريادة العالمية في مختلف المؤشرات التنموية.</p>
                                                    </div>
                                                </div>
                                                <div class="absolute right-[24px] top-[90px] bottom-[48px] w-[3px] bg-[#d1d5db] rounded-full"></div>
                                            </div>
                                        </div>
                                    </div>
                                `);
                            });
                        </script>

                    </div>
                    <footer class="py-8 text-center text-gray-400 text-sm">الأمانة العامة لمجلس الوزراء &copy; 2026</footer>
                </div>
            </main>

            <!-- 30PX GAP (Middle) -->
            <div class="w-[30px] shrink-0 order-2"></div>

            <!-- SIDEBAR (Pinned Left) -->
            <aside id="sidebar" class="bg-[#f1f1f1] border-r border-gray-200 shadow-[10px_0_20px_rgba(0,0,0,0.03)] transition-[width] duration-500 ease-in-out shrink-0 w-[80px] rounded-r-[32px] overflow-hidden relative self-stretch order-3">
                <div class="w-[550px] h-full flex flex-row">
                    <div class="w-[80px] h-full flex flex-col items-center pt-8 shrink-0 z-10 bg-[#f1f1f1]">
                        <button onclick="toggleSidebar()" class="w-12 h-12 rounded-full shadow-inner mb-6 hover:scale-105 transition-transform overflow-hidden">
                            <img src="https://cdn.jsdelivr.net/gh/codic-design/source/IMAGES/AI.gif" class="w-full h-full object-cover">
                        </button>
                        <button onclick="toggleSidebar()" class="text-[#07355c] hover:bg-gray-100 w-12 h-12 rounded-lg flex items-center justify-center transition-colors">
                            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                        </button>
                    </div>

                    <div id="sidebar-expanded-content" class="w-[470px] h-full flex flex-col pt-8 opacity-0 pointer-events-none transition-opacity duration-300 px-6">
                        <h2 class="font-bold text-2xl text-[#07355c] mb-6 text-right">مستشار الذكاء الاصطناعي</h2>

                        <div class="ai-input-wrapper mb-6 shrink-0">
                            <textarea id="ai-chat-input" class="w-full h-16 bg-transparent outline-none resize-none text-right text-gray-700 placeholder-gray-300" placeholder="اسأل المستشار..."></textarea>
                            <div class="flex items-center justify-between mt-3">
                                <div class="flex items-center gap-2">
                                    <button onclick="simulateAi('مقارنة دولية')" class="ai-shortcut-btn">مقارنة دولية</button>
                                    <button onclick="simulateAi('تحليل')" class="ai-shortcut-btn">تحليل</button>
                                    <button onclick="simulateAi('تلخيص')" class="ai-shortcut-btn">تلخيص</button>
                                </div>
                                <button onclick="simulateAi('custom')" class="bg-[#07355c] text-white p-2 rounded-full hover:scale-110 transition-all"><svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="2.5"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg></button>
                            </div>
                        </div>

                        <div id="ai-history-container" class="flex-1 overflow-y-auto custom-scrollbar pb-10 space-y-4">
                            <div id="live-ai-response" class="hidden"></div>
                            <div id="saved-ai-list" class="space-y-4"></div>
                        </div>
                    </div>
                </div>
            </aside>

        </div>
    </div>

    <!-- Note Modal -->
    <div id="note-modal" class="modal-overlay fixed inset-0 z-[100] items-center justify-center bg-black/40 backdrop-blur-sm" onclick="handleOutsideClick(event, 'note-modal')">
        <div class="bg-white w-[90%] max-w-2xl rounded-[40px] p-8 shadow-2xl relative border border-gray-100 max-h-[85vh] flex flex-col" onclick="event.stopPropagation()">
            <button onclick="closeNoteModal()" class="absolute top-6 left-8 text-gray-400 hover:text-gray-600 transition-colors">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h3 class="font-bold text-2xl text-[#07355c] mb-6 text-right pr-4">ملاحظات الموضوع</h3>
            
            <div id="notes-history-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-4 mb-6 pr-2 text-right"></div>

            <div class="border-t border-gray-100 pt-6 mt-auto">
                <textarea id="note-textarea" class="w-full h-32 p-5 bg-gray-50 border border-gray-100 rounded-3xl resize-none outline-none text-right text-gray-700 placeholder-gray-400" placeholder="أضف ملاحظة جديدة هنا..."></textarea>
                <div class="flex flex-row-reverse gap-4 mt-4">
                    <button id="save-note-btn" onclick="saveNote()" class="bg-[#07355c] text-white font-bold px-10 py-3 rounded-full hover:scale-105 transition-transform">حفظ الملاحظة</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ai-review-modal" class="modal-overlay fixed inset-0 z-[100] items-center justify-center bg-black/40 backdrop-blur-sm" onclick="handleOutsideClick(event, 'ai-review-modal')">
        <div class="bg-white w-[90%] max-w-2xl rounded-[40px] p-8 shadow-2xl relative border border-gray-100 max-h-[80vh] flex flex-col" onclick="event.stopPropagation()">
             <button onclick="closeAiReviewModal()" class="absolute top-6 left-8 text-gray-400 hover:text-gray-600 transition-colors">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <div class="mb-6 pr-2 text-right">
                <h3 class="font-bold text-2xl text-[#07355c]">سجل استجابات المستشار</h3>
            </div>
            <div id="ai-history-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-4 pr-2 text-right"></div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        let currentActiveTopicId = null;
        let currentEditingNoteId = null;
        let pendingAiResponse = null; 
        let editingNoteIndex = null;
        
        const notesStore = {}; 
        const savedAiHistory = {}; 

        function startApp() {
            const landing = document.getElementById('landing-page');
            const app = document.getElementById('app-page');
            landing.classList.add('opacity-0');
            setTimeout(() => { landing.classList.add('hidden'); app.classList.remove('hidden'); setTimeout(() => app.classList.remove('opacity-0'), 50); }, 700);
        }

        // Global click handler for closing accordion when clicking outside
        document.addEventListener('click', function(e) {
            if (!currentActiveTopicId) return;
            
            // Check if click is outside the active accordion item
            const activeAccordion = document.querySelector('.accordion-item.active');
            if (activeAccordion && !activeAccordion.contains(e.target)) {
                // Ignore clicks on modals or sidebar
                if (!e.target.closest('.modal-overlay') && !e.target.closest('#sidebar') && !e.target.closest('.ai-indicator') && !e.target.closest('.note-indicator')) {
                    const closeBtn = activeAccordion.querySelector('button[onclick*="closeAccordion"]');
                    if (closeBtn) closeAccordion(e, closeBtn);
                }
            }
        });

        function handleOutsideClick(event, modalId) {
            if (event.target.id === modalId) {
                if (modalId === 'note-modal') closeNoteModal();
                if (modalId === 'ai-review-modal') closeAiReviewModal();
            }
        }

        function toggleAccordion(element) {
            const item = element.closest('.accordion-item');
            if (!item) return;
            const body = item.querySelector('.accordion-body');
            const isActive = item.classList.contains('active');
            const topicId = item.getAttribute('data-topic-id');
            
            document.querySelectorAll('.accordion-item.active').forEach(other => {
                if (other !== item) {
                    other.classList.remove('active');
                    const ob = other.querySelector('.accordion-body');
                    if (ob) ob.style.maxHeight = '0px';
                }
            });
            
            if (!isActive) {
                item.classList.add('active');
                if (body) body.style.maxHeight = "1000px";
                currentActiveTopicId = topicId;
                document.getElementById('ai-chat-input').placeholder = `اسأل عن موضوع رقم (${topicId})...`;
                renderAiHistory(topicId);
                document.getElementById('live-ai-response').classList.add('hidden');
                pendingAiResponse = null;
            } else {
                item.classList.remove('active');
                if (body) body.style.maxHeight = '0px';
                currentActiveTopicId = null;
            }
        }

        function closeAccordion(event, btn) {
            if (event) event.stopPropagation();
            const item = btn.closest('.accordion-item');
            if (item) {
                item.classList.remove('active');
                const body = item.querySelector('.accordion-body');
                if (body) body.style.maxHeight = '0px';
            }
            currentActiveTopicId = null;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const expanded = document.getElementById('sidebar-expanded-content');
            const mainContent = document.getElementById('main-content');
            if (sidebar.classList.contains('w-[80px]')) {
                sidebar.classList.remove('w-[80px]'); sidebar.classList.add('w-[550px]');
                mainContent.classList.add('compact-mode');
                setTimeout(() => expanded.classList.remove('opacity-0', 'pointer-events-none'), 200);
            } else {
                expanded.classList.add('opacity-0', 'pointer-events-none');
                sidebar.classList.remove('w-[550px]'); sidebar.classList.add('w-[80px]');
                mainContent.classList.remove('compact-mode');
            }
        }

        async function callGeminiAPI(prompt, systemInstruction, retryCount = 0) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                if (!response.ok) {
                    if (retryCount < 5) {
                        await new Promise(res => setTimeout(res, Math.pow(2, retryCount) * 1000));
                        return callGeminiAPI(prompt, systemInstruction, retryCount + 1);
                    }
                    throw new Error('API Error');
                }
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
            } catch (error) {
                return "خطأ في الاتصال بالذكاء الاصطناعي.";
            }
        }

        async function simulateAi(type) {
            if (!currentActiveTopicId) return;
            const liveArea = document.getElementById('live-ai-response');
            const chatInput = document.getElementById('ai-chat-input');
            const customQuery = chatInput.value.trim();
            
            liveArea.classList.remove('hidden');
            const typeLabel = type === 'تلخيص' ? 'ملخص ذكي' : (type === 'تحليل' ? 'تحليل استراتيجي' : (type === 'مقارنة دولية' ? 'مقارنة دولية' : 'رد مخصص'));
            
            liveArea.innerHTML = `<div class="ai-card bg-white border border-blue-200 p-5 rounded-3xl shadow-md mb-4 border-dashed animate-pulse text-right"><p class="text-gray-400 text-[13px] italic">جاري المعالجة...</p></div>`;

            const contentElement = document.getElementById(`topic-content-${currentActiveTopicId}`);
            const topicText = contentElement ? contentElement.innerText : "";
            const systemPrompt = `أنت مستشار استراتيجي لحكومة الإمارات. استخدم محتوى الموضوع المقدم كمرجع أساسي لإجابتك.`;
            
            let userPrompt = "";
            if (type === 'تلخيص') userPrompt = `لخص محتوى هذا الموضوع: ${topicText}`;
            else if (type === 'تحليل') userPrompt = `حلل هذا الموضوع استراتيجياً: ${topicText}`;
            else if (type === 'مقارنة دولية') userPrompt = `قارن هذا الموضوع مع الممارسات الدولية: ${topicText}`;
            else userPrompt = `بناءً على الموضوع: (${topicText})، أجب على: ${customQuery}`;

            const aiResponse = await callGeminiAPI(userPrompt, systemPrompt);
            pendingAiResponse = { type: typeLabel, text: aiResponse };

            liveArea.innerHTML = `<div class="ai-card bg-white border border-blue-100 p-5 rounded-3xl shadow-sm mb-4 text-right">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-bold text-gray-400">${typeLabel}</span>
                    <button onclick="saveCurrentAiResponse()" class="bg-[#07355c] text-white px-5 py-1.5 rounded-full text-[11px] font-bold hover:bg-opacity-90">حفظ الرد</button>
                </div>
                <div class="text-gray-600 text-[13px] leading-relaxed whitespace-pre-wrap">${aiResponse}</div>
            </div>`;
            chatInput.value = "";
        }

        function saveCurrentAiResponse() {
            if (!currentActiveTopicId || !pendingAiResponse) return;
            if (!savedAiHistory[currentActiveTopicId]) savedAiHistory[currentActiveTopicId] = [];
            savedAiHistory[currentActiveTopicId].unshift({
                type: pendingAiResponse.type,
                text: pendingAiResponse.text,
                time: new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'})
            });
            document.getElementById('live-ai-response').classList.add('hidden');
            pendingAiResponse = null;
            renderAiHistory(currentActiveTopicId);
            updateTopicBadges(currentActiveTopicId);
        }

        function renderAiHistory(topicId) {
            const list = document.getElementById('saved-ai-list');
            list.innerHTML = "";
            const history = savedAiHistory[topicId] || [];
            history.forEach(item => {
                const card = document.createElement('div');
                card.className = "ai-card bg-white border border-gray-100 p-5 rounded-3xl shadow-sm mb-4 text-right";
                card.innerHTML = `<div class="flex items-center justify-between mb-3"><span class="text-[10px] text-gray-400">${item.time}</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-[#07355c] bg-blue-50 px-3 py-1 rounded-full">${item.type}</span><span class="text-green-600 text-[10px] font-bold">✓ محفوظ</span></div></div><div class="text-gray-600 text-[13px] leading-relaxed whitespace-pre-wrap">${item.text}</div>`;
                list.appendChild(card);
            });
        }

        function updateTopicBadges(topicId) {
            const aiHistory = savedAiHistory[topicId] || [];
            const aiIndicator = document.getElementById(`ai-indicator-${topicId}`);
            const aiBadge = document.getElementById(`ai-count-${topicId}`);
            if (aiHistory.length > 0) {
                if (aiIndicator) aiIndicator.classList.remove('hidden');
                if (aiBadge) { aiBadge.innerText = aiHistory.length; aiBadge.classList.remove('hidden'); }
            } else {
                if (aiIndicator) aiIndicator.classList.add('hidden');
                if (aiBadge) aiBadge.classList.add('hidden');
            }

            const noteHistory = notesStore[topicId] || [];
            const noteIndicator = document.getElementById(`note-indicator-${topicId}`);
            const noteBadge = document.getElementById(`note-count-${topicId}`);
            if (noteHistory.length > 0) {
                if (noteIndicator) noteIndicator.classList.remove('hidden');
                if (noteBadge) { noteBadge.innerText = noteHistory.length; noteBadge.classList.remove('hidden'); }
            } else {
                if (noteIndicator) noteIndicator.classList.add('hidden');
                if (noteBadge) noteBadge.classList.add('hidden');
            }
        }

        function openNoteModal(topicId) {
            currentEditingNoteId = topicId;
            editingNoteIndex = null;
            renderNotesHistory();
            document.getElementById('note-textarea').value = "";
            document.getElementById('save-note-btn').innerText = "حفظ الملاحظة";
            document.getElementById('note-modal').classList.add('active');
        }

        function renderNotesHistory() {
            const list = document.getElementById('notes-history-list');
            list.innerHTML = "";
            const history = notesStore[currentEditingNoteId] || [];
            if (history.length === 0) {
                list.innerHTML = `<div class="py-12 text-center text-gray-300 italic">لا توجد ملاحظات سابقة.</div>`;
            } else {
                history.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = "bg-gray-50 border border-gray-100 p-4 rounded-3xl shadow-sm relative group";
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[10px] text-gray-400">${item.time}</span>
                            <div class="flex gap-2">
                                <button onclick="prepareEditNote(${index})" class="text-[#07355c] opacity-50 hover:opacity-100"><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                <button onclick="deleteNote(${index})" class="text-red-500 opacity-50 hover:opacity-100"><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                            </div>
                        </div>
                        <p class="text-gray-700 text-sm whitespace-pre-wrap">${item.text}</p>
                    `;
                    list.appendChild(card);
                });
            }
        }

        function prepareEditNote(index) {
            const history = notesStore[currentEditingNoteId] || [];
            document.getElementById('note-textarea').value = history[index].text;
            document.getElementById('save-note-btn').innerText = "تحديث الملاحظة";
            editingNoteIndex = index;
            document.getElementById('note-textarea').focus();
        }

        function deleteNote(index) {
            if (!notesStore[currentEditingNoteId]) return;
            notesStore[currentEditingNoteId].splice(index, 1);
            renderNotesHistory();
            updateTopicBadges(currentEditingNoteId);
        }

        function saveNote() {
            const text = document.getElementById('note-textarea').value.trim();
            if (!text) return;
            if (!notesStore[currentEditingNoteId]) notesStore[currentEditingNoteId] = [];
            const now = new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});
            if (editingNoteIndex !== null) {
                notesStore[currentEditingNoteId][editingNoteIndex].text = text;
                notesStore[currentEditingNoteId][editingNoteIndex].time = now;
                editingNoteIndex = null;
                document.getElementById('save-note-btn').innerText = "حفظ الملاحظة";
            } else {
                notesStore[currentEditingNoteId].unshift({ text, time: now });
            }
            document.getElementById('note-textarea').value = "";
            renderNotesHistory();
            updateTopicBadges(currentEditingNoteId);
        }

        function closeNoteModal() { document.getElementById('note-modal').classList.remove('active'); }

        function openAiReviewModal(topicId) {
            const list = document.getElementById('ai-history-list');
            list.innerHTML = "";
            const history = savedAiHistory[topicId] || [];
            if (history.length === 0) list.innerHTML = `<div class="py-12 text-center text-gray-400 italic">لا يوجد ردود محفوظة لهذا الموضوع بعد.</div>`;
            else history.forEach(item => {
                const card = document.createElement('div');
                card.className = "bg-gray-50 border border-gray-100 p-5 rounded-3xl shadow-sm mb-4 text-right";
                card.innerHTML = `<div class="flex items-center justify-between mb-3"><span class="text-[10px] text-gray-400">${item.time}</span><span class="text-xs font-bold text-[#07355c] bg-blue-50 px-3 py-1 rounded-full">${item.type}</span></div><div class="text-gray-600 text-sm leading-relaxed whitespace-pre-wrap">${item.text}</div>`;
                list.appendChild(card);
            });
            document.getElementById('ai-review-modal').classList.add('active');
        }
        function closeAiReviewModal() { document.getElementById('ai-review-modal').classList.remove('active'); }

        function openSidebarWithFocus(topicId) {
            if (currentActiveTopicId !== topicId) {
                const item = document.querySelector(`.accordion-item[data-topic-id="${topicId}"]`);
                if (item) toggleAccordion(item.querySelector('.topic-item'));
            }
            if (document.getElementById('sidebar').classList.contains('w-[80px]')) toggleSidebar();
            document.getElementById('ai-chat-input').focus();
        }
    </script>
</body>
</html>
